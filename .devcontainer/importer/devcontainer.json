{
    "name": "HFP Analytics Importer (Azure Functions)",
    "dockerComposeFile": [
        "../docker-compose.yml"
    ],
    "service": "importer",
    "workspaceFolder": "/workspace",
    "shutdownAction": "stopCompose",
    
    // Forward ports for Azure Functions, database, and Azurite
    // Note: Database and Azurite are shared with API container
    "forwardPorts": [
        7071,  // Azure Functions
        5433,  // PostgreSQL (shared with API)
        10100, // Azurite Blob (shared with API)
        10101, // Azurite Queue (shared with API)
        10102  // Azurite Table (shared with API)
    ],
    
    "portsAttributes": {
        "7071": {
            "label": "Azure Functions",
            "onAutoForward": "notify"
        },
        "5433": {
            "label": "PostgreSQL"
        },
        "10100": {
            "label": "Azurite Blob"
        },
        "10101": {
            "label": "Azurite Queue"
        },
        "10102": {
            "label": "Azurite Table"
        }
    },

    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance",
                "ms-python.black-formatter",
                "ms-python.isort",
                "ms-python.debugpy",
                "ms-azuretools.vscode-azurefunctions",
                "ms-azuretools.vscode-docker",
                "mtxr.sqltools",
                "mtxr.sqltools-driver-pg",
                "GitHub.copilot",
                "esbenp.prettier-vscode"
            ],
            "settings": {
                "python.defaultInterpreterPath": "/usr/local/bin/python",
                "python.linting.enabled": true,
                "python.linting.pylintEnabled": false,
                "python.formatting.provider": "black",
                "python.testing.pytestEnabled": true,
                "python.testing.unittestEnabled": false,
                "editor.formatOnSave": true,
                "editor.codeActionsOnSave": {
                    "source.organizeImports": "explicit"
                },
                "[python]": {
                    "editor.defaultFormatter": "ms-python.python"
                },
                "azureFunctions.deploySubpath": "python",
                "azureFunctions.projectRuntime": "~4",
                "azureFunctions.projectLanguage": "Python",
                "launch": {
                    "configurations": [],
                    "compounds": []
                },
                "tasks": {
                    "version": "2.0.0",
                    "tasks": []
                }
            }
        }
    },

    // Commands to run after container is created
    "postCreateCommand": "pip install -r python/requirements.txt && pip install debugpy pytest pytest-asyncio httpx && mkdir -p /workspace/.vscode && cp /workspace/.devcontainer/shared/launch.json /workspace/.vscode/launch.json && cp /workspace/.devcontainer/shared/tasks.json /workspace/.vscode/tasks.json && cd /workspace/python && ln -sf durable/httpStart httpStart && ln -sf durable/orchestrator orchestrator && ln -sf durable/getStatusActivity getStatusActivity && ln -sf durable/setStatusActivity setStatusActivity && ln -sf durable/reclusterAnalysisActivity reclusterAnalysisActivity",
    
    // Commands to run when attaching to existing container
    "postAttachCommand": "echo 'Container attached. To start Azure Functions:\n  cd python\n  func start --port 7071'",

    // Features to add to the container
    "features": {
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/github-cli:1": {},
        "ghcr.io/devcontainers/features/azure-cli:1": {}
    },

    // Set environment variables
    "containerEnv": {
        "PYTHONPATH": "/workspace/python",
        "PYTHONUNBUFFERED": "1",
        "TZ": "Europe/Helsinki"
    },

    // Run as non-root user
    "remoteUser": "vscode"
}
